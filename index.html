<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙƒØ´Ù Ø£Ø¬Ù‡Ø²Ø© Ø´Ø±ÙƒØ© Ø§Ù„Ù</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Tahoma, Arial;
  background:#f4f6f8;
  padding:15px;
}
.box{
  background:#fff;
  padding:30px;
  max-width:1300px;
  margin:auto;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.logo{text-align:center;}
.logo img{
  width:120px;height:120px;
  border-radius:50%;
  border:3px solid #0d6efd;
}
.company-name{
  color:#0d6efd;
  font-weight:bold;
  margin-top:10px;
}
h2{text-align:center;margin:20px 0;}

.counter{
  background:#eef3ff;
  padding:12px 30px;
  border-radius:14px;
  font-weight:bold;
  width:max-content;
  margin:15px auto;
}

.search-box{
  display:flex;
  gap:10px;
}
.search-box input{
  flex:1;
  padding:14px;
  border-radius:10px;
  border:1px solid #ccc;
}
.search-box button{
  padding:14px 30px;
  border-radius:10px;
  background:#0d6efd;
  color:#fff;
  border:none;
}

.card{
  display:flex;
  gap:30px;
  border-radius:16px;
  padding:20px;
  margin-top:20px;
  background:#fafafa;
  border:3px solid;
}
.card.ok{border-color:#28a745;}
.card.late{border-color:#dc3545;}

.card-text{flex:2;line-height:2;}
.card-image{flex:1;}
.card-image img{
  width:100%;
  max-width:320px;
  border-radius:14px;
}

.status.ok{color:#28a745;font-weight:bold;}
.status.late{color:#dc3545;font-weight:bold;}

.no-results{
  text-align:center;
  color:#dc3545;
  font-size:20px;
  margin-top:30px;
}

@media(max-width:768px){
  .card{flex-direction:column;}
}
</style>
</head>

<body>

<div class="box">

  <div class="logo">
    <img src="./assets/alef.jpg">
    <div class="company-name">Ø´Ø±ÙƒØ© Ø§Ù„Ù Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¯Ø¹Ø§ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù…</div>
  </div>

  <h2>ğŸ“‹ ÙƒØ´Ù Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø´Ø±ÙƒØ©</h2>

  <div class="counter" id="countAll">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>

  <div class="search-box">
    <input id="search" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„)">
    <button onclick="load()">Ø¨Ø­Ø«</button>
  </div>

  <div id="result"></div>

</div>

<script>
const SHEET_ID = "1rwrsnvKALSUMlmtp_9KOVE03-65niHv2-tBcOGbfmk4";
const SHEET_NAME = "ÙƒØ´Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©";

function parseDate(str){
  if(!str) return null;
  const p = str.split("-");
  return new Date(p[0], p[1]-1, p[2]);
}

function driveToImage(url){
  if(!url) return "";
  const match = url.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : "";
}

window.onload = load;

async function load(){
  const key = search.value.trim();
  const box = document.getElementById("result");
  box.innerHTML = "";

  let total = 0;
  let shown = 0;

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const json = JSON.parse((await res.text()).substring(47).slice(0,-2));
  const rows = json.table.rows;

  rows.forEach(r=>{
    const deviceNo  = r.c[0]?.v ?? "";
    const type      = r.c[1]?.v ?? "";
    const name      = r.c[2]?.v ?? "";
    const desc      = r.c[3]?.v ?? "";
    const place     = r.c[4]?.v ?? "";
    const rawImage  = r.c[5]?.v || r.c[5]?.f || "";
    const imageUrl  = driveToImage(rawImage);
    const lastCheck = r.c[6]?.f ?? "";
    const nextCheck = r.c[7]?.f ?? "";

    total++;

    if(key && !deviceNo.includes(key)) return;
    shown++;

    const today = new Date();
    today.setHours(0,0,0,0);

    const nextDate = parseDate(nextCheck);
    const late = nextDate && nextDate < today;

    box.innerHTML += `
    <div class="card ${late?'late':'ok'}">
      <div class="card-text">
        <b>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²:</b> ${deviceNo}<br>
        <b>Ø§Ù„Ù†ÙˆØ¹:</b> ${type}<br>
        <b>Ø§Ù„Ø§Ø³Ù…:</b> ${name}<br>
        <b>Ø§Ù„ÙˆØµÙ:</b> ${desc}<br>
        <b>Ø§Ù„Ù…ÙƒØ§Ù†:</b> ${place}<br>
        <b>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙØ­Øµ:</b> ${lastCheck}<br>
        <b>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ Ø§Ù„Ù‚Ø§Ø¯Ù…:</b> ${nextCheck}<br>
        <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b>
        <span class="status ${late?'late':'ok'}">
          ${late ? 'ğŸ”´ Ù…ØªØ£Ø®Ø±' : 'ğŸŸ¢ Ø³Ù„ÙŠÙ…'}
        </span>
      </div>
      ${imageUrl ? `
      <div class="card-image">
        <img src="${imageUrl}" referrerpolicy="no-referrer">
      </div>` : ``}
    </div>`;
  });

  document.getElementById("countAll").innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}`;

  if(shown === 0){
    box.innerHTML = `<div class="no-results">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ</div>`;
  }
}
</script>

</body>
</html>
